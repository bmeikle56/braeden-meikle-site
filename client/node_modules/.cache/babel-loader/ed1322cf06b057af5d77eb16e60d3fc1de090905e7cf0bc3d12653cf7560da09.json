{"ast":null,"code":"/*!\n * Sitemap\n * Copyright(c) 2011 Eugene Kalinin\n * MIT Licensed\n */\n\nvar ut = require('./utils'),\n  err = require('./errors'),\n  urlparser = require('url'),\n  fs = require('fs'),\n  urljoin = require('url-join'),\n  _ = require('underscore');\nexports.Sitemap = Sitemap;\nexports.SitemapItem = SitemapItem;\nexports.createSitemap = createSitemap;\nexports.createSitemapIndex = createSitemapIndex;\nexports.buildSitemapIndex = buildSitemapIndex;\n\n/**\n * Shortcut for `new Sitemap (...)`.\n *\n * @param   {Object}        conf\n * @param   {String}        conf.hostname\n * @param   {String|Array}  conf.urls\n * @param   {Number}        conf.cacheTime\n * @param   {String}        conf.xslUrl\n * @param   {String}        conf.xmlNs\n * @return  {Sitemap}\n */\nfunction createSitemap(conf) {\n  return new Sitemap(conf.urls, conf.hostname, conf.cacheTime, conf.xslUrl, conf.xmlNs);\n}\nfunction safeUrl(conf) {\n  var loc = conf['url'];\n  if (!conf['safe']) {\n    var url_parts = urlparser.parse(conf['url']);\n    if (!url_parts['protocol']) {\n      throw new err.NoURLProtocolError();\n    }\n    loc = ut.htmlEscape(conf['url']);\n  }\n  return loc;\n}\n\n/**\n * Item in sitemap\n */\nfunction SitemapItem(conf) {\n  var conf = conf || {},\n    is_safe_url = conf['safe'];\n  if (!conf['url']) {\n    throw new err.NoURLError();\n  }\n\n  // URL of the page\n  if (!conf.cdata) {\n    this.loc = safeUrl(conf);\n  } else {\n    this.loc = conf.url;\n  }\n\n  // If given a file to use for last modified date\n  if (conf['lastmodfile']) {\n    //console.log('should read stat from file: ' + conf['lastmodfile']);\n    var file = conf['lastmodfile'];\n    var stat = fs.statSync(file);\n    var mtime = stat.mtime;\n    var dt = new Date(mtime);\n    this.lastmod = ut.getTimestampFromDate(dt, conf['lastmodrealtime']);\n  }\n  // The date of last modification (YYYY-MM-DD)\n  else if (conf['lastmod']) {\n    // append the timezone offset so that dates are treated as local time.\n    // Otherwise the Unit tests fail sometimes.\n    var timezoneOffset = 'UTC-' + new Date().getTimezoneOffset() / 60 + '00';\n    timezoneOffset = timezoneOffset.replace('--', '-');\n    var dt = new Date(conf['lastmod'] + ' ' + timezoneOffset);\n    this.lastmod = ut.getTimestampFromDate(dt, conf['lastmodrealtime']);\n  } else if (conf['lastmodISO']) {\n    this.lastmod = conf['lastmodISO'];\n  }\n\n  // How frequently the page is likely to change\n  // due to this field is optional no default value is set\n  // please see: http://www.sitemaps.org/protocol.html\n  this.changefreq = conf['changefreq'];\n  if (!is_safe_url && this.changefreq) {\n    if (['always', 'hourly', 'daily', 'weekly', 'monthly', 'yearly', 'never'].indexOf(this.changefreq) === -1) {\n      throw new err.ChangeFreqInvalidError();\n    }\n  }\n\n  // The priority of this URL relative to other URLs\n  // due to this field is optional no default value is set\n  // please see: http://www.sitemaps.org/protocol.html\n  this.priority = conf['priority'];\n  if (!is_safe_url && this.priority) {\n    if (!(this.priority >= 0.0 && this.priority <= 1.0) || typeof this.priority !== 'number') {\n      throw new err.PriorityInvalidError();\n    }\n  }\n  this.news = conf['news'] || null;\n  this.img = conf['img'] || null;\n  this.links = conf['links'] || null;\n  this.expires = conf['expires'] || null;\n  this.androidLink = conf['androidLink'] || null;\n  this.mobile = conf['mobile'] || null;\n  this.video = conf['video'] || null;\n  this.ampLink = conf['ampLink'] || null;\n}\n\n/**\n *  Create sitemap xml\n *  @return {String}\n */\nSitemapItem.prototype.toXML = function () {\n  return this.toString();\n};\n\n/**\n *  Alias for toXML()\n *  @return {String}\n */\nSitemapItem.prototype.toString = function () {\n  // result xml\n  var xml = '<url> {loc} {lastmod} {changefreq} {priority} {img} {video} {links} {expires} {androidLink} {mobile} {news} {ampLink}</url>'\n    // xml property\n    ,\n    props = ['loc', 'img', 'video', 'lastmod', 'changefreq', 'priority', 'links', 'expires', 'androidLink', 'mobile', 'news', 'ampLink']\n    // property array size (for loop)\n    ,\n    ps = props.length\n    // current property name (for loop)\n    ,\n    p;\n  while (ps--) {\n    p = props[ps];\n    if (this[p] && p == 'img') {\n      var imagexml = '';\n      // Image handling\n      if (typeof this[p] != 'object' || this[p].length == undefined) {\n        // make it an array\n        this[p] = [this[p]];\n      }\n      this[p].forEach(function (image) {\n        if (typeof image != 'object') {\n          // it’s a string\n          // make it an object\n          image = {\n            url: image\n          };\n        }\n        var caption = image.caption ? '<image:caption><![CDATA[' + image.caption + ']]></image:caption>' : '';\n        var geoLocation = image.geoLocation ? '<image:geo_location>' + image.geoLocation + '</image:geo_location>' : '';\n        var title = image.title ? '<image:title><![CDATA[' + image.title + ']]></image:title>' : '';\n        var license = image.license ? '<image:license>' + image.license + '</image:license>' : '';\n        imagexml += '<image:image><image:loc>' + image.url + '</image:loc>' + caption + geoLocation + title + license + '</image:image> ';\n      });\n      xml = xml.replace('{' + p + '}', imagexml);\n    } else if (this[p] && p == 'video') {\n      var videoxml = '';\n      // Image handling\n      if (typeof this[p] != 'object' || this[p].length == undefined) {\n        // make it an array\n        this[p] = [this[p]];\n      }\n      this[p].forEach(function (video) {\n        if (typeof video != 'object' || !video.thumbnail_loc || !video.title || !video.description) {\n          // has to be an object and include required categories https://developers.google.com/webmasters/videosearch/sitemaps\n          throw new err.InvalidVideoFormat();\n        }\n        videoxml += '<video:video>' + '<video:thumbnail_loc>' + video.thumbnail_loc + '</video:thumbnail_loc>' + '<video:title><![CDATA[' + video.title + ']]></video:title>' + '<video:description><![CDATA[' + video.description + ']]></video:description>';\n        if (video.content_loc) videoxml += '<video:content_loc>' + video.content_loc + '</video:content_loc>';\n        if (video.player_loc) videoxml += '<video:player_loc>' + video.player_loc + '</video:player_loc>';\n        if (video.duration) videoxml += '<video:duration>' + video.duration + '</video:duration>';\n        if (video.expiration_date) videoxml += '<video:expiration_date>' + video.expiration_date + '</video:expiration_date>';\n        if (video.rating) videoxml += '<video:rating>' + video.rating + '</video:rating>';\n        if (video.view_count) videoxml += '<video:view_count>' + video.view_count + '</video:view_count>';\n        if (video.publication_date) videoxml += '<video:publication_date>' + video.publication_date + '</video:publication_date>';\n        if (video.family_friendly) videoxml += '<video:family_friendly>' + video.family_friendly + '</video:family_friendly>';\n        if (video.tag) videoxml += '<video:tag>' + video.tag + '</video:tag>';\n        if (video.category) videoxml += '<video:category>' + video.category + '</video:category>';\n        if (video.restriction) videoxml += '<video:restriction>' + video.restriction + '</video:restriction>';\n        if (video.gallery_loc) videoxml += '<video:gallery_loc>' + video.gallery_loc + '</video:gallery_loc>';\n        if (video.price) videoxml += '<video:price>' + video.price + '</video:price>';\n        if (video.requires_subscription) videoxml += '<video:requires_subscription>' + video.requires_subscription + '</video:requires_subscription>';\n        if (video.uploader) videoxml += '<video:uploader>' + video.uploader + '</video:uploader>';\n        if (video.platform) videoxml += '<video:platform>' + video.platform + '</video:platform>';\n        if (video.live) videoxml += '<video:live>' + video.live + '</video:live>';\n        videoxml += '</video:video>';\n      });\n      xml = xml.replace('{' + p + '}', videoxml);\n    } else if (this[p] && p == 'links') {\n      xml = xml.replace('{' + p + '}', this[p].map(function (link) {\n        return '<xhtml:link rel=\"alternate\" hreflang=\"' + link.lang + '\" href=\"' + safeUrl(link) + '\" />';\n      }).join(\" \"));\n    } else if (this[p] && p === 'expires') {\n      xml = xml.replace('{' + p + '}', '<' + p + '>' + new Date(this[p]).toISOString() + '</' + p + '>');\n    } else if (this[p] && p == 'androidLink') {\n      xml = xml.replace('{' + p + '}', '<xhtml:link rel=\"alternate\" href=\"' + this[p] + '\" />');\n    } else if (this[p] && p == 'mobile') {\n      xml = xml.replace('{' + p + '}', '<mobile:mobile/>');\n    } else if (p == 'priority' && this[p] >= 0.0 && this[p] <= 1.0) {\n      xml = xml.replace('{' + p + '}', '<' + p + '>' + parseFloat(this[p]).toFixed(1) + '</' + p + '>');\n    } else if (this[p] && p == 'ampLink') {\n      xml = xml.replace('{' + p + '}', '<xhtml:link rel=\"amphtml\" href=\"' + this[p] + '\" />');\n    } else if (this[p] && p == 'news') {\n      var newsitem = '<news:news>';\n      if (this[p].publication) {\n        newsitem += '<news:publication>';\n        if (this[p].publication.name) {\n          newsitem += '<news:name>' + this[p].publication.name + '</news:name>';\n        }\n        if (this[p].publication.language) {\n          newsitem += '<news:language>' + this[p].publication.language + '</news:language>';\n        }\n        newsitem += '</news:publication>';\n      }\n      if (this[p].access) {\n        newsitem += '<news:access>' + this[p].access + '</news:access>';\n      }\n      if (this[p].genres) {\n        newsitem += '<news:genres>' + this[p].genres + '</news:genres>';\n      }\n      if (this[p].publication_date) {\n        newsitem += '<news:publication_date>' + this[p].publication_date + '</news:publication_date>';\n      }\n      if (this[p].title) {\n        newsitem += '<news:title>' + this[p].title + '</news:title>';\n      }\n      if (this[p].keywords) {\n        newsitem += '<news:keywords>' + this[p].keywords + '</news:keywords>';\n      }\n      if (this[p].stock_tickers) {\n        newsitem += '<news:stock_tickers>' + this[p].stock_tickers + '</news:stock_tickers>';\n      }\n      newsitem += '</news:news>';\n      xml = xml.replace('{' + p + '}', newsitem);\n    } else if (this[p]) {\n      xml = xml.replace('{' + p + '}', '<' + p + '>' + this[p] + '</' + p + '>');\n    } else {\n      xml = xml.replace('{' + p + '}', '');\n    }\n    xml = xml.replace('  ', ' ');\n  }\n  return xml.replace('  ', ' ');\n};\n\n/**\n * Sitemap constructor\n * @param {String|Array}  urls\n * @param {String}        hostname    optional\n * @param {Number}        cacheTime   optional in milliseconds; 0 - cache disabled\n * @param {String}        xslUrl            optional\n * @param {String}        xmlNs            optional\n */\nfunction Sitemap(urls, hostname, cacheTime, xslUrl, xmlNs) {\n  // This limit is defined by Google. See:\n  // http://sitemaps.org/protocol.php#index\n  this.limit = 50000;\n\n  // Base domain\n  this.hostname = hostname;\n\n  // URL list for sitemap\n  this.urls = [];\n\n  // Make copy of object\n  if (urls) _.extend(this.urls, urls instanceof Array ? urls : [urls]);\n\n  // sitemap cache\n  this.cacheResetPeriod = cacheTime || 0;\n  this.cache = '';\n  this.xslUrl = xslUrl;\n  this.xmlNs = xmlNs;\n}\n\n/**\n *  Clear sitemap cache\n */\nSitemap.prototype.clearCache = function () {\n  this.cache = '';\n};\n\n/**\n *  Can cache be used\n */\nSitemap.prototype.isCacheValid = function () {\n  var currTimestamp = ut.getTimestamp();\n  return this.cacheResetPeriod && this.cache && this.cacheSetTimestamp + this.cacheResetPeriod >= currTimestamp;\n};\n\n/**\n *  Fill cache\n */\nSitemap.prototype.setCache = function (newCache) {\n  this.cache = newCache;\n  this.cacheSetTimestamp = ut.getTimestamp();\n  return this.cache;\n};\n\n/**\n *  Add url to sitemap\n *  @param {String} url\n */\nSitemap.prototype.add = function (url) {\n  return this.urls.push(url);\n};\n\n/**\n *  Delete url from sitemap\n *  @param {String} url\n */\nSitemap.prototype.del = function (url) {\n  var index_to_remove = [],\n    key = '',\n    self = this;\n  if (typeof url == 'string') {\n    key = url;\n  } else {\n    key = url['url'];\n  }\n\n  // find\n  this.urls.forEach(function (elem, index) {\n    if (typeof elem == 'string') {\n      if (elem == key) {\n        index_to_remove.push(index);\n      }\n    } else {\n      if (elem['url'] == key) {\n        index_to_remove.push(index);\n      }\n    }\n  });\n\n  // delete\n  index_to_remove.forEach(function (elem) {\n    self.urls.splice(elem, 1);\n  });\n  return index_to_remove.length;\n};\n\n/**\n *  Create sitemap xml\n *  @param {Function}     callback  Callback function with one argument — xml\n */\nSitemap.prototype.toXML = function (callback) {\n  if (typeof callback === 'undefined') {\n    return this.toString();\n  }\n  var self = this;\n  process.nextTick(function () {\n    try {\n      return callback(null, self.toString());\n    } catch (err) {\n      return callback(err);\n    }\n  });\n};\nvar reProto = /^https?:\\/\\//i;\n\n/**\n *  Synchronous alias for toXML()\n *  @return {String}\n */\nSitemap.prototype.toString = function () {\n  var self = this,\n    xml;\n  if (!self.xmlNs) {\n    xml = ['<?xml version=\"1.0\" encoding=\"UTF-8\"?>', '<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" ' + 'xmlns:news=\"http://www.google.com/schemas/sitemap-news/0.9\" ' + 'xmlns:xhtml=\"http://www.w3.org/1999/xhtml\" ' + 'xmlns:mobile=\"http://www.google.com/schemas/sitemap-mobile/1.0\" ' + 'xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" ' + 'xmlns:video=\"http://www.google.com/schemas/sitemap-video/1.1\">'];\n  } else {\n    xml = ['<?xml version=\"1.0\" encoding=\"UTF-8\"?>', '<urlset ' + this.xmlNs + '>'];\n  }\n  if (self.xslUrl) {\n    xml.splice(1, 0, '<?xml-stylesheet type=\"text/xsl\" href=\"' + self.xslUrl + '\"?>');\n  }\n  if (self.isCacheValid()) {\n    return self.cache;\n  }\n\n  // TODO: if size > limit: create sitemapindex\n\n  self.urls.forEach(function (elem, index) {\n    // SitemapItem\n    var smi = elem;\n\n    // create object with url property\n    if (typeof elem == 'string') {\n      smi = {\n        'url': elem\n      };\n    }\n    // insert domain name\n    if (self.hostname) {\n      if (!reProto.test(smi.url)) {\n        smi.url = urljoin(self.hostname, smi.url);\n      }\n      if (smi.img) {\n        if (typeof smi.img == 'string') {\n          // string -> array of objects\n          smi.img = [{\n            url: smi.img\n          }];\n        }\n        if (typeof smi.img == 'object' && smi.img.length == undefined) {\n          // object -> array of objects\n          smi.img = [smi.img];\n        }\n        // prepend hostname to all image urls\n        smi.img.forEach(function (img) {\n          if (!reProto.test(img.url)) {\n            img.url = urljoin(self.hostname, img.url);\n          }\n        });\n      }\n      if (smi.links) {\n        smi.links.forEach(function (link) {\n          if (!reProto.test(link.url)) {\n            link.url = urljoin(self.hostname, link.url);\n          }\n        });\n      }\n    }\n    xml.push(new SitemapItem(smi));\n  });\n  // close xml\n  xml.push('</urlset>');\n  return self.setCache(xml.join('\\n'));\n};\nSitemap.prototype.toGzip = function (callback) {\n  var zlib = require('zlib');\n  if (typeof callback === 'function') {\n    zlib.gzip(this.toString(), callback);\n  } else {\n    return zlib.gzipSync(this.toString());\n  }\n};\n\n/**\n * Shortcut for `new SitemapIndex (...)`.\n *\n * @param   {Object}        conf\n * @param   {String|Array}  conf.urls\n * @param   {String}        conf.targetFolder\n * @param   {String}        conf.hostname\n * @param   {Number}        conf.cacheTime\n * @param   {String}        conf.sitemapName\n * @param   {Number}        conf.sitemapSize\n * @param   {String}        conf.xslUrl\n * @return  {SitemapIndex}\n */\nfunction createSitemapIndex(conf) {\n  return new SitemapIndex(conf.urls, conf.targetFolder, conf.hostname, conf.cacheTime, conf.sitemapName, conf.sitemapSize, conf.xslUrl, conf.gzip, conf.callback);\n}\n\n/**\n * Builds a sitemap index from urls\n *\n * @param   {Object}    conf\n * @param   {Array}     conf.urls\n * @param   {String}    conf.xslUrl\n * @param   {String}    conf.xmlNs\n * @return  {String}    XML String of SitemapIndex\n */\nfunction buildSitemapIndex(conf) {\n  var xml = [];\n  var lastmod;\n  xml.push('<?xml version=\"1.0\" encoding=\"UTF-8\"?>');\n  if (conf.xslUrl) {\n    xml.push('<?xml-stylesheet type=\"text/xsl\" href=\"' + conf.xslUrl + '\"?>');\n  }\n  if (!conf.xmlNs) {\n    xml.push('<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" ' + 'xmlns:mobile=\"http://www.google.com/schemas/sitemap-mobile/1.0\" ' + 'xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" ' + 'xmlns:video=\"http://www.google.com/schemas/sitemap-video/1.1\">');\n  } else {\n    xml.push('<sitemapindex ' + conf.xmlNs + '>');\n  }\n  if (conf.lastmodISO) {\n    lastmod = conf.lastmodISO;\n  } else if (conf.lastmodrealtime) {\n    lastmod = new Date().toISOString();\n  } else if (conf.lastmod) {\n    lastmod = new Date(conf.lastmod).toISOString();\n  }\n  conf.urls.forEach(function (url) {\n    xml.push('<sitemap>');\n    xml.push('<loc>' + url + '</loc>');\n    if (lastmod) {\n      xml.push('<lastmod>' + lastmod + '</lastmod>');\n    }\n    xml.push('</sitemap>');\n  });\n  xml.push('</sitemapindex>');\n  return xml.join('\\n');\n}\n\n/**\n * Sitemap index (for several sitemaps)\n * @param {String|Array}  urls\n * @param {String}        targetFolder\n * @param {String}        hostname      optional\n * @param {Number}        cacheTime     optional in milliseconds\n * @param {String}        sitemapName   optional\n * @param {Number}        sitemapSize   optional\n * @param {Number}        xslUrl                optional\n * @param {Boolean}       gzip          optional\n * @param {Function}      callback      optional\n */\nfunction SitemapIndex(urls, targetFolder, hostname, cacheTime, sitemapName, sitemapSize, xslUrl, gzip, callback) {\n  var self = this;\n  self.fs = require('fs');\n\n  // Base domain\n  self.hostname = hostname;\n  if (sitemapName === undefined) {\n    self.sitemapName = 'sitemap';\n  } else {\n    self.sitemapName = sitemapName;\n  }\n\n  // This limit is defined by Google. See:\n  // http://sitemaps.org/protocol.php#index\n  self.sitemapSize = sitemapSize;\n  self.xslUrl = xslUrl;\n  self.sitemapId = 0;\n  self.sitemaps = [];\n  self.targetFolder = '.';\n  try {\n    if (!self.fs.statSync(targetFolder).isDirectory()) {\n      throw new err.UndefinedTargetFolder();\n    }\n  } catch (err) {\n    throw new err.UndefinedTargetFolder();\n  }\n  self.targetFolder = targetFolder;\n\n  // URL list for sitemap\n  self.urls = urls || [];\n  if (!(self.urls instanceof Array)) {\n    self.urls = [self.urls];\n  }\n  self.chunks = ut.chunkArray(self.urls, self.sitemapSize);\n  self.callback = callback;\n  var processesCount = self.chunks.length + 1;\n  self.chunks.forEach(function (chunk, index) {\n    var extension = '.xml' + (gzip ? '.gz' : ''),\n      filename = self.sitemapName + '-' + self.sitemapId++ + extension;\n    self.sitemaps.push(filename);\n    var sitemap = createSitemap({\n      hostname: self.hostname,\n      cacheTime: self.cacheTime,\n      // 600 sec - cache purge period\n      urls: chunk,\n      xslUrl: self.xslUrl\n    });\n    var stream = self.fs.createWriteStream(targetFolder + '/' + filename);\n    stream.once('open', function (fd) {\n      stream.write(gzip ? sitemap.toGzip() : sitemap.toString());\n      stream.end();\n      processesCount--;\n      if (processesCount === 0 && typeof self.callback === 'function') {\n        self.callback(null, true);\n      }\n    });\n  });\n  var sitemapUrls = self.sitemaps.map(function (sitemap, index) {\n    return hostname + '/' + sitemap;\n  });\n  var smConf = {\n    urls: sitemapUrls,\n    xslUrl: self.xslUrl,\n    xmlNs: self.xmlNs\n  };\n  var xmlString = buildSitemapIndex(smConf);\n  var stream = self.fs.createWriteStream(targetFolder + '/' + self.sitemapName + '-index.xml');\n  stream.once('open', function (fd) {\n    stream.write(xmlString);\n    stream.end();\n    processesCount--;\n    if (processesCount === 0 && typeof self.callback === 'function') {\n      self.callback(null, true);\n    }\n  });\n}","map":{"version":3,"names":["ut","require","err","urlparser","fs","urljoin","_","exports","Sitemap","SitemapItem","createSitemap","createSitemapIndex","buildSitemapIndex","conf","urls","hostname","cacheTime","xslUrl","xmlNs","safeUrl","loc","url_parts","parse","NoURLProtocolError","htmlEscape","is_safe_url","NoURLError","cdata","url","file","stat","statSync","mtime","dt","Date","lastmod","getTimestampFromDate","timezoneOffset","getTimezoneOffset","replace","changefreq","indexOf","ChangeFreqInvalidError","priority","PriorityInvalidError","news","img","links","expires","androidLink","mobile","video","ampLink","prototype","toXML","toString","xml","props","ps","length","p","imagexml","undefined","forEach","image","caption","geoLocation","title","license","videoxml","thumbnail_loc","description","InvalidVideoFormat","content_loc","player_loc","duration","expiration_date","rating","view_count","publication_date","family_friendly","tag","category","restriction","gallery_loc","price","requires_subscription","uploader","platform","live","map","link","lang","join","toISOString","parseFloat","toFixed","newsitem","publication","name","language","access","genres","keywords","stock_tickers","limit","extend","Array","cacheResetPeriod","cache","clearCache","isCacheValid","currTimestamp","getTimestamp","cacheSetTimestamp","setCache","newCache","add","push","del","index_to_remove","key","self","elem","index","splice","callback","process","nextTick","reProto","smi","test","toGzip","zlib","gzip","gzipSync","SitemapIndex","targetFolder","sitemapName","sitemapSize","lastmodISO","lastmodrealtime","sitemapId","sitemaps","isDirectory","UndefinedTargetFolder","chunks","chunkArray","processesCount","chunk","extension","filename","sitemap","stream","createWriteStream","once","fd","write","end","sitemapUrls","smConf","xmlString"],"sources":["/Users/braedenmeikle/Documents/repo/braeden-meikle-site/node_modules/sitemap/lib/sitemap.js"],"sourcesContent":["/*!\n * Sitemap\n * Copyright(c) 2011 Eugene Kalinin\n * MIT Licensed\n */\n\nvar ut = require('./utils')\n  , err = require('./errors')\n  , urlparser = require('url')\n  , fs = require('fs')\n  , urljoin = require('url-join')\n  , _ = require('underscore');\n\nexports.Sitemap = Sitemap;\nexports.SitemapItem = SitemapItem;\nexports.createSitemap = createSitemap;\nexports.createSitemapIndex = createSitemapIndex;\nexports.buildSitemapIndex = buildSitemapIndex;\n\n/**\n * Shortcut for `new Sitemap (...)`.\n *\n * @param   {Object}        conf\n * @param   {String}        conf.hostname\n * @param   {String|Array}  conf.urls\n * @param   {Number}        conf.cacheTime\n * @param   {String}        conf.xslUrl\n * @param   {String}        conf.xmlNs\n * @return  {Sitemap}\n */\nfunction createSitemap(conf) {\n  return new Sitemap(conf.urls, conf.hostname, conf.cacheTime, conf.xslUrl, conf.xmlNs);\n}\n\nfunction safeUrl(conf) {\n  var loc = conf['url'];\n  if (!conf['safe']) {\n    var url_parts = urlparser.parse(conf['url']);\n    if (!url_parts['protocol']) {\n      throw new err.NoURLProtocolError();\n    }\n\n    loc = ut.htmlEscape(conf['url']);\n  }\n  return loc;\n}\n\n/**\n * Item in sitemap\n */\nfunction SitemapItem(conf) {\n  var conf = conf || {}\n    , is_safe_url = conf['safe'];\n\n  if (!conf['url']) {\n    throw new err.NoURLError();\n  }\n\n  // URL of the page\n  if(!conf.cdata) {\n    this.loc = safeUrl(conf);\n  } else {\n    this.loc = conf.url;\n  }\n\n  // If given a file to use for last modified date\n  if (conf['lastmodfile']) {\n    //console.log('should read stat from file: ' + conf['lastmodfile']);\n    var file = conf['lastmodfile'];\n\n    var stat = fs.statSync(file);\n\n    var mtime = stat.mtime;\n\n    var dt = new Date(mtime);\n    this.lastmod = ut.getTimestampFromDate(dt, conf['lastmodrealtime']);\n\n  }\n  // The date of last modification (YYYY-MM-DD)\n  else if (conf['lastmod']) {\n    // append the timezone offset so that dates are treated as local time.\n    // Otherwise the Unit tests fail sometimes.\n    var timezoneOffset = 'UTC-' + (new Date().getTimezoneOffset() / 60) + '00';\n    timezoneOffset = timezoneOffset.replace('--', '-');\n    var dt = new Date(conf['lastmod'] + ' ' + timezoneOffset);\n    this.lastmod = ut.getTimestampFromDate(dt, conf['lastmodrealtime']);\n  } else if (conf['lastmodISO']) {\n    this.lastmod = conf['lastmodISO'];\n  }\n\n  // How frequently the page is likely to change\n  // due to this field is optional no default value is set\n  // please see: http://www.sitemaps.org/protocol.html\n  this.changefreq = conf['changefreq'];\n  if (!is_safe_url && this.changefreq) {\n    if (['always', 'hourly', 'daily', 'weekly', 'monthly',\n        'yearly', 'never'].indexOf(this.changefreq) === -1) {\n      throw new err.ChangeFreqInvalidError();\n    }\n  }\n\n  // The priority of this URL relative to other URLs\n  // due to this field is optional no default value is set\n  // please see: http://www.sitemaps.org/protocol.html\n  this.priority = conf['priority'];\n  if (!is_safe_url && this.priority) {\n    if (!(this.priority >= 0.0 && this.priority <= 1.0) || typeof this.priority !== 'number') {\n      throw new err.PriorityInvalidError();\n    }\n  }\n\n  this.news = conf['news'] || null;\n  this.img = conf['img'] || null;\n  this.links = conf['links'] || null;\n  this.expires = conf['expires'] || null;\n  this.androidLink = conf['androidLink'] || null;\n  this.mobile = conf['mobile'] || null;\n  this.video = conf['video'] || null;\n  this.ampLink = conf['ampLink'] || null;\n}\n\n/**\n *  Create sitemap xml\n *  @return {String}\n */\nSitemapItem.prototype.toXML = function () {\n  return this.toString();\n};\n\n/**\n *  Alias for toXML()\n *  @return {String}\n */\nSitemapItem.prototype.toString = function () {\n  // result xml\n  var xml = '<url> {loc} {lastmod} {changefreq} {priority} {img} {video} {links} {expires} {androidLink} {mobile} {news} {ampLink}</url>'\n  // xml property\n    , props = ['loc', 'img', 'video', 'lastmod', 'changefreq', 'priority', 'links', 'expires', 'androidLink', 'mobile', 'news', 'ampLink']\n  // property array size (for loop)\n    , ps = props.length\n  // current property name (for loop)\n    , p;\n\n  while (ps--) {\n    p = props[ps];\n\n    if (this[p] && p == 'img') {\n      var imagexml = '';\n      // Image handling\n      if (typeof(this[p]) != 'object' || this[p].length == undefined) {\n        // make it an array\n        this[p] = [this[p]];\n      }\n      this[p].forEach(function (image) {\n        if(typeof(image) != 'object') {\n          // it’s a string\n          // make it an object\n          image = {url: image};\n        }\n        var caption = image.caption ? '<image:caption><![CDATA['+image.caption+']]></image:caption>' : '';\n        var geoLocation = image.geoLocation ? '<image:geo_location>'+image.geoLocation+'</image:geo_location>' : '';\n        var title = image.title ? '<image:title><![CDATA['+image.title+']]></image:title>' : '';\n        var license = image.license ? '<image:license>'+image.license+'</image:license>' : '';\n\n        imagexml += '<image:image><image:loc>' + image.url + '</image:loc>' + caption + geoLocation + title + license + '</image:image> ';\n      });\n\n      xml = xml.replace('{' + p + '}', imagexml);\n\n    } else if (this[p] && p == 'video') {\n      var videoxml = '';\n      // Image handling\n      if (typeof(this[p]) != 'object' || this[p].length == undefined) {\n        // make it an array\n        this[p] = [this[p]];\n      }\n      this[p].forEach(function (video) {\n        if(typeof(video) != 'object' || !video.thumbnail_loc || !video.title || !video.description) {\n          // has to be an object and include required categories https://developers.google.com/webmasters/videosearch/sitemaps\n          throw new err.InvalidVideoFormat();\n        }\n        videoxml += '<video:video>' +\n          '<video:thumbnail_loc>' + video.thumbnail_loc + '</video:thumbnail_loc>' +\n          '<video:title><![CDATA[' + video.title + ']]></video:title>' +\n          '<video:description><![CDATA[' + video.description + ']]></video:description>';\n        if (video.content_loc)\n          videoxml += '<video:content_loc>' + video.content_loc + '</video:content_loc>';\n        if (video.player_loc)\n          videoxml += '<video:player_loc>' + video.player_loc + '</video:player_loc>';\n        if (video.duration)\n          videoxml += '<video:duration>' + video.duration + '</video:duration>';\n        if (video.expiration_date)\n          videoxml += '<video:expiration_date>' + video.expiration_date + '</video:expiration_date>';\n        if (video.rating)\n          videoxml += '<video:rating>' + video.rating + '</video:rating>';\n        if (video.view_count)\n          videoxml += '<video:view_count>' + video.view_count + '</video:view_count>';\n        if (video.publication_date)\n          videoxml += '<video:publication_date>' + video.publication_date + '</video:publication_date>';\n        if (video.family_friendly)\n          videoxml += '<video:family_friendly>' + video.family_friendly + '</video:family_friendly>';\n        if (video.tag)\n          videoxml += '<video:tag>' + video.tag + '</video:tag>';\n        if (video.category)\n          videoxml += '<video:category>' + video.category + '</video:category>';\n        if (video.restriction)\n          videoxml += '<video:restriction>' + video.restriction + '</video:restriction>';\n        if (video.gallery_loc)\n          videoxml += '<video:gallery_loc>' + video.gallery_loc + '</video:gallery_loc>';\n        if (video.price)\n          videoxml += '<video:price>' + video.price + '</video:price>';\n        if (video.requires_subscription)\n          videoxml += '<video:requires_subscription>' + video.requires_subscription + '</video:requires_subscription>';\n        if (video.uploader)\n          videoxml += '<video:uploader>' + video.uploader + '</video:uploader>';\n        if (video.platform)\n          videoxml += '<video:platform>' + video.platform + '</video:platform>';\n        if (video.live)\n          videoxml += '<video:live>' + video.live + '</video:live>';\n        videoxml += '</video:video>'\n      });\n\n      xml = xml.replace('{' + p + '}', videoxml);\n\n    } else if (this[p] && p == 'links') {\n      xml = xml.replace('{' + p + '}',\n        this[p].map(function (link) {\n          return '<xhtml:link rel=\"alternate\" hreflang=\"' + link.lang + '\" href=\"' + safeUrl(link) + '\" />';\n        }).join(\" \"));\n    } else if (this[p] && p === 'expires') {\n      xml = xml.replace('{' + p + '}', '<' + p + '>' + new Date(this[p]).toISOString() + '</' + p + '>');\n    } else if (this[p] && p == 'androidLink') {\n      xml = xml.replace('{' + p + '}', '<xhtml:link rel=\"alternate\" href=\"' + this[p] + '\" />');\n    } else if (this[p] && p == 'mobile') {\n      xml = xml.replace('{' + p + '}', '<mobile:mobile/>');\n    } else if (p == 'priority' && (this[p] >= 0.0 && this[p] <= 1.0)) {\n      xml = xml.replace('{' + p + '}',\n        '<' + p + '>' + parseFloat(this[p]).toFixed(1) + '</' + p + '>');\n    } else if (this[p] && p == 'ampLink') {\n      xml = xml.replace('{' + p + '}',\n        '<xhtml:link rel=\"amphtml\" href=\"' + this[p] + '\" />');\n    } else if (this[p] && p == 'news') {\n      var newsitem = '<news:news>';\n\n      if (this[p].publication) {\n        newsitem += '<news:publication>';\n        if (this[p].publication.name) {\n          newsitem += '<news:name>' + this[p].publication.name + '</news:name>';\n        }\n        if (this[p].publication.language) {\n          newsitem += '<news:language>' + this[p].publication.language + '</news:language>';\n        }\n        newsitem += '</news:publication>';\n      }\n\n      if (this[p].access) {\n        newsitem += '<news:access>' + this[p].access + '</news:access>';\n      }\n      if (this[p].genres) {\n        newsitem += '<news:genres>' + this[p].genres + '</news:genres>';\n      }\n      if (this[p].publication_date) {\n        newsitem += '<news:publication_date>' + this[p].publication_date + '</news:publication_date>';\n      }\n      if (this[p].title) {\n        newsitem += '<news:title>' + this[p].title + '</news:title>';\n      }\n      if (this[p].keywords) {\n        newsitem += '<news:keywords>' + this[p].keywords + '</news:keywords>';\n      }\n      if (this[p].stock_tickers) {\n        newsitem += '<news:stock_tickers>' + this[p].stock_tickers + '</news:stock_tickers>';\n      }\n\n      newsitem += '</news:news>';\n\n      xml = xml.replace('{' + p + '}', newsitem);\n    } else if (this[p]) {\n      xml = xml.replace('{' + p + '}',\n        '<' + p + '>' + this[p] + '</' + p + '>');\n    } else {\n      xml = xml.replace('{' + p + '}', '');\n    }\n    xml = xml.replace('  ', ' ');\n  }\n\n  return xml.replace('  ', ' ');\n};\n\n/**\n * Sitemap constructor\n * @param {String|Array}  urls\n * @param {String}        hostname    optional\n * @param {Number}        cacheTime   optional in milliseconds; 0 - cache disabled\n * @param {String}        xslUrl            optional\n * @param {String}        xmlNs            optional\n */\nfunction Sitemap(urls, hostname, cacheTime, xslUrl, xmlNs) {\n\n  // This limit is defined by Google. See:\n  // http://sitemaps.org/protocol.php#index\n  this.limit = 50000\n\n  // Base domain\n  this.hostname = hostname;\n\n  // URL list for sitemap\n  this.urls = [];\n\n  // Make copy of object\n  if (urls) _.extend(this.urls, (urls instanceof Array) ? urls : [urls]);\n\n  // sitemap cache\n  this.cacheResetPeriod = cacheTime || 0;\n  this.cache = '';\n\n  this.xslUrl = xslUrl;\n  this.xmlNs = xmlNs;\n}\n\n/**\n *  Clear sitemap cache\n */\nSitemap.prototype.clearCache = function () {\n  this.cache = '';\n};\n\n/**\n *  Can cache be used\n */\nSitemap.prototype.isCacheValid = function () {\n  var currTimestamp = ut.getTimestamp();\n  return this.cacheResetPeriod && this.cache &&\n    (this.cacheSetTimestamp + this.cacheResetPeriod) >= currTimestamp;\n};\n\n/**\n *  Fill cache\n */\nSitemap.prototype.setCache = function (newCache) {\n  this.cache = newCache;\n  this.cacheSetTimestamp = ut.getTimestamp();\n  return this.cache;\n};\n\n/**\n *  Add url to sitemap\n *  @param {String} url\n */\nSitemap.prototype.add = function (url) {\n  return this.urls.push(url);\n};\n\n/**\n *  Delete url from sitemap\n *  @param {String} url\n */\nSitemap.prototype.del = function (url) {\n  var index_to_remove = [],\n    key = '',\n    self = this;\n\n  if (typeof url == 'string') {\n    key = url;\n  } else {\n    key = url['url'];\n  }\n\n  // find\n  this.urls.forEach(function (elem, index) {\n    if (typeof elem == 'string') {\n      if (elem == key) {\n        index_to_remove.push(index);\n      }\n    } else {\n      if (elem['url'] == key) {\n        index_to_remove.push(index);\n      }\n    }\n  });\n\n  // delete\n  index_to_remove.forEach(function (elem) {\n    self.urls.splice(elem, 1);\n  });\n\n  return index_to_remove.length;\n};\n\n/**\n *  Create sitemap xml\n *  @param {Function}     callback  Callback function with one argument — xml\n */\nSitemap.prototype.toXML = function (callback) {\n  if (typeof callback === 'undefined') {\n    return this.toString();\n  }\n  var self = this;\n  process.nextTick(function () {\n    try {\n      return callback(null, self.toString());\n    } catch (err) {\n      return callback(err);\n    }\n  });\n};\n\nvar reProto = /^https?:\\/\\//i;\n\n/**\n *  Synchronous alias for toXML()\n *  @return {String}\n */\nSitemap.prototype.toString = function () {\n  var self = this, xml;\n  if(!self.xmlNs) {\n      xml = ['<?xml version=\"1.0\" encoding=\"UTF-8\"?>',\n      '<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" ' +\n      'xmlns:news=\"http://www.google.com/schemas/sitemap-news/0.9\" ' +\n      'xmlns:xhtml=\"http://www.w3.org/1999/xhtml\" ' +\n      'xmlns:mobile=\"http://www.google.com/schemas/sitemap-mobile/1.0\" ' +\n      'xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" ' +\n      'xmlns:video=\"http://www.google.com/schemas/sitemap-video/1.1\">'\n    ];\n  } else {\n    xml = ['<?xml version=\"1.0\" encoding=\"UTF-8\"?>', '<urlset '+ this.xmlNs + '>']\n  }\n\n  if (self.xslUrl) {\n    xml.splice(1, 0,\n      '<?xml-stylesheet type=\"text/xsl\" href=\"' + self.xslUrl + '\"?>');\n  }\n\n  if (self.isCacheValid()) {\n    return self.cache;\n  }\n\n  // TODO: if size > limit: create sitemapindex\n\n  self.urls.forEach(function (elem, index) {\n    // SitemapItem\n    var smi = elem;\n\n    // create object with url property\n    if (typeof elem == 'string') {\n      smi = {'url': elem};\n    }\n    // insert domain name\n    if (self.hostname) {\n      if (!reProto.test(smi.url)) {\n        smi.url = urljoin(self.hostname, smi.url);\n      }\n      if (smi.img) {\n        if (typeof smi.img == 'string') {\n          // string -> array of objects\n          smi.img = [{url: smi.img}];\n        }\n        if (typeof smi.img == 'object' && smi.img.length == undefined) {\n          // object -> array of objects\n          smi.img = [smi.img];\n        }\n        // prepend hostname to all image urls\n        smi.img.forEach(function (img) {\n          if (!reProto.test(img.url)) {\n            img.url = urljoin(self.hostname, img.url);\n          }\n        });\n      }\n      if (smi.links) {\n        smi.links.forEach(function (link) {\n          if (!reProto.test(link.url)) {\n            link.url = urljoin(self.hostname, link.url);\n          }\n        });\n      }\n    }\n    xml.push(new SitemapItem(smi));\n  });\n  // close xml\n  xml.push('</urlset>');\n\n  return self.setCache(xml.join('\\n'));\n};\n\nSitemap.prototype.toGzip = function (callback) {\n  var zlib = require('zlib');\n\n  if (typeof callback === 'function') {\n    zlib.gzip(this.toString(), callback);\n  } else {\n    return zlib.gzipSync(this.toString());\n  }\n};\n\n/**\n * Shortcut for `new SitemapIndex (...)`.\n *\n * @param   {Object}        conf\n * @param   {String|Array}  conf.urls\n * @param   {String}        conf.targetFolder\n * @param   {String}        conf.hostname\n * @param   {Number}        conf.cacheTime\n * @param   {String}        conf.sitemapName\n * @param   {Number}        conf.sitemapSize\n * @param   {String}        conf.xslUrl\n * @return  {SitemapIndex}\n */\nfunction createSitemapIndex(conf) {\n  return new SitemapIndex(conf.urls,\n    conf.targetFolder,\n    conf.hostname,\n    conf.cacheTime,\n    conf.sitemapName,\n    conf.sitemapSize,\n    conf.xslUrl,\n    conf.gzip,\n    conf.callback);\n}\n\n/**\n * Builds a sitemap index from urls\n *\n * @param   {Object}    conf\n * @param   {Array}     conf.urls\n * @param   {String}    conf.xslUrl\n * @param   {String}    conf.xmlNs\n * @return  {String}    XML String of SitemapIndex\n */\nfunction buildSitemapIndex(conf) {\n  var xml = [];\n  var lastmod;\n\n  xml.push('<?xml version=\"1.0\" encoding=\"UTF-8\"?>');\n  if (conf.xslUrl) {\n    xml.push('<?xml-stylesheet type=\"text/xsl\" href=\"' + conf.xslUrl + '\"?>');\n  }\n  if(!conf.xmlNs) {\n    xml.push('<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" ' +\n      'xmlns:mobile=\"http://www.google.com/schemas/sitemap-mobile/1.0\" ' +\n      'xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\" ' +\n      'xmlns:video=\"http://www.google.com/schemas/sitemap-video/1.1\">');\n  } else {\n    xml.push('<sitemapindex ' + conf.xmlNs + '>')\n  }\n\n  if(conf.lastmodISO) {\n    lastmod = conf.lastmodISO;\n  } else if(conf.lastmodrealtime) {\n    lastmod = new Date().toISOString();\n  } else if(conf.lastmod) {\n    lastmod = new Date(conf.lastmod).toISOString();\n  }\n\n\n  conf.urls.forEach(function (url) {\n    xml.push('<sitemap>');\n    xml.push('<loc>' + url + '</loc>');\n    if(lastmod) {\n      xml.push('<lastmod>' + lastmod + '</lastmod>');\n    }\n    xml.push('</sitemap>');\n  });\n\n  xml.push('</sitemapindex>');\n\n  return xml.join('\\n');\n}\n\n/**\n * Sitemap index (for several sitemaps)\n * @param {String|Array}  urls\n * @param {String}        targetFolder\n * @param {String}        hostname      optional\n * @param {Number}        cacheTime     optional in milliseconds\n * @param {String}        sitemapName   optional\n * @param {Number}        sitemapSize   optional\n * @param {Number}        xslUrl                optional\n * @param {Boolean}       gzip          optional\n * @param {Function}      callback      optional\n */\nfunction SitemapIndex(urls, targetFolder, hostname, cacheTime, sitemapName, sitemapSize, xslUrl, gzip, callback) {\n\n  var self = this;\n\n  self.fs = require('fs');\n\n  // Base domain\n  self.hostname = hostname;\n\n  if (sitemapName === undefined) {\n    self.sitemapName = 'sitemap';\n  }\n  else {\n    self.sitemapName = sitemapName;\n  }\n\n  // This limit is defined by Google. See:\n  // http://sitemaps.org/protocol.php#index\n  self.sitemapSize = sitemapSize;\n\n  self.xslUrl = xslUrl;\n\n  self.sitemapId = 0;\n\n  self.sitemaps = [];\n\n  self.targetFolder = '.';\n\n  try {\n    if (!self.fs.statSync(targetFolder).isDirectory()) {\n      throw new err.UndefinedTargetFolder();\n    }\n  } catch (err) {\n    throw new err.UndefinedTargetFolder();\n  }\n\n  self.targetFolder = targetFolder;\n\n  // URL list for sitemap\n  self.urls = urls || [];\n  if (!(self.urls instanceof Array)) {\n    self.urls = [self.urls]\n  }\n\n  self.chunks = ut.chunkArray(self.urls, self.sitemapSize);\n\n  self.callback = callback;\n\n  var processesCount = self.chunks.length + 1;\n\n  self.chunks.forEach(function (chunk, index) {\n    var extension = '.xml' + (gzip ? '.gz' : ''),\n      filename = self.sitemapName + '-' + self.sitemapId++ + extension;\n\n    self.sitemaps.push(filename);\n\n    var sitemap = createSitemap({\n      hostname: self.hostname,\n      cacheTime: self.cacheTime, // 600 sec - cache purge period\n      urls: chunk,\n      xslUrl: self.xslUrl\n    });\n\n    var stream = self.fs.createWriteStream(targetFolder + '/' + filename);\n    stream.once('open', function (fd) {\n      stream.write(gzip ? sitemap.toGzip() : sitemap.toString());\n      stream.end();\n      processesCount--;\n      if (processesCount === 0 && typeof self.callback === 'function') {\n        self.callback(null, true);\n      }\n    });\n\n  });\n\n  var sitemapUrls = self.sitemaps.map(function(sitemap, index){\n    return hostname + '/' + sitemap;\n  });\n  var smConf = {urls: sitemapUrls, xslUrl: self.xslUrl, xmlNs: self.xmlNs};\n  var xmlString = buildSitemapIndex(smConf);\n\n  var stream = self.fs.createWriteStream(targetFolder + '/' +\n    self.sitemapName + '-index.xml');\n  stream.once('open', function (fd) {\n    stream.write(xmlString);\n    stream.end();\n    processesCount--;\n    if (processesCount === 0 && typeof self.callback === 'function') {\n      self.callback(null, true);\n    }\n  });\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}